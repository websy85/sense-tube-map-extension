var Events=function(a,b){this.canvas=a,this.context=b,this.stage=void 0,this.listening=!1,this.mousePos=null,this.mouseDown=!1,this.mouseUp=!1,this.mouseOver=!1,this.mouseMove=!1,this.touchPos=null,this.touchStart=!1,this.touchMove=!1,this.touchEnd=!1,this.currentRegion=null,this.regionIndex=0,this.lastRegionIndex=-1,this.mouseOverRegionIndex=-1};Events.prototype.getContext=function(){return this.context},Events.prototype.getCanvas=function(){return this.canvas},Events.prototype.clear=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},Events.prototype.getCanvasPos=function(){for(var a=this.getCanvas(),b=0,c=0;a&&a.tagName&&"BODY"!=a.tagName;)b+=a.offsetTop,c+=a.offsetLeft,a=a.offsetParent;return{top:b,left:c}},Events.prototype.setStage=function(a){this.stage=a,this.listen()},Events.prototype.reset=function(a){a||(a=window.event),this.setMousePosition(a),this.setTouchPosition(a),this.regionIndex=0,void 0!==this.stage&&this.stage(),this.mouseOver=!1,this.mouseMove=!1,this.mouseDown=!1,this.mouseUp=!1,this.touchStart=!1,this.touchMove=!1,this.touchEnd=!1},Events.prototype.listen=function(){var a=this;void 0!==this.stage&&this.stage(),this.canvas.addEventListener("mousedown",function(b){a.mouseDown=!0,a.reset(b)},!1),this.canvas.addEventListener("mousemove",function(b){a.reset(b)},!1),this.canvas.addEventListener("mouseup",function(b){a.mouseUp=!0,a.reset(b)},!1),this.canvas.addEventListener("mouseover",function(b){a.reset(b)},!1),this.canvas.addEventListener("mouseout",function(b){a.mousePos=null},!1),this.canvas.addEventListener("touchstart",function(b){a.touchStart=!0,a.reset(b)},!1),this.canvas.addEventListener("touchmove",function(b){a.reset(b)},!1),this.canvas.addEventListener("touchend",function(b){a.touchEnd=!0,a.reset(b)},!1)},Events.prototype.getMousePos=function(a){return this.mousePos},Events.prototype.getTouchPos=function(a){return this.touchPos},Events.prototype.setMousePosition=function(a){var b=a.clientX-this.getCanvasPos().left+window.pageXOffset,c=a.clientY-this.getCanvasPos().top+window.pageYOffset;this.mousePos={x:b,y:c}},Events.prototype.setTouchPosition=function(a){if(void 0!==a.touches&&1==a.touches.length){var b=a.touches[0],c=b.pageX-this.getCanvasPos().left+window.pageXOffset,d=b.pageY-this.getCanvasPos().top+window.pageYOffset;this.touchPos={x:c,y:d}}},Events.prototype.beginRegion=function(){this.currentRegion={},this.regionIndex++},Events.prototype.addRegionEventListener=function(a,b){var c=-1==a.indexOf("touch")?"on"+a:a;this.currentRegion[c]=b},Events.prototype.closeRegion=function(){var a=this.touchPos||this.mousePos;null!==a&&this.context.isPointInPath(a.x,a.y)?(this.lastRegionIndex!=this.regionIndex&&(this.lastRegionIndex=this.regionIndex),this.mouseDown&&void 0!==this.currentRegion.onmousedown?(this.currentRegion.onmousedown(),this.mouseDown=!1):this.mouseUp&&void 0!==this.currentRegion.onmouseup?(this.currentRegion.onmouseup(),this.mouseUp=!1):this.mouseOver||this.regionIndex==this.mouseOverRegionIndex||void 0===this.currentRegion.onmouseover?this.mouseMove||void 0===this.currentRegion.onmousemove||(this.currentRegion.onmousemove(),this.mouseMove=!0):(this.currentRegion.onmouseover(),this.mouseOver=!0,this.mouseOverRegionIndex=this.regionIndex),this.touchStart&&void 0!==this.currentRegion.touchstart&&(this.currentRegion.touchstart(),this.touchStart=!1),this.touchEnd&&void 0!==this.currentRegion.touchend&&(this.currentRegion.touchend(),this.touchEnd=!1),this.touchMove||void 0===this.currentRegion.touchmove||(this.currentRegion.touchmove(),this.touchMove=!0)):this.regionIndex==this.lastRegionIndex&&(this.lastRegionIndex=-1,this.mouseOverRegionIndex=-1,void 0!==this.currentRegion.onmouseout&&this.currentRegion.onmouseout())};var TubeMapViz=function(){function a(a){a=a||{},this.debug=a.debug||!1,this.disableHighlighting=a.disableHighlighting||!1,this.padding=a.padding||30,this.stationRadius=a.stationRadius||8,this.lineWidth=a.lineWidth||5,this.lineSpacing=a.lineSpacing||5,this.labelLineHeight=a.labelLineHeight||13,this.labelColour=a.labelColour||"black",this.labelWrapThreshold=a.labelWrapThreshold||4,this.fontSize=a.fontSize||10,this.fontFamily=a.fontFamily||"Arial",this.fontWeight=a.fontWeight||"Normal",this.highlightScale=a.highlightScale||1.3,this.inactiveColour=a.inactiveColour||"#DDDDDD",this.stationColour=a.stationColour||"black",this.stationThickness=a.stationThickness||this.lineWidth,this.stationClicked=a.stationClicked||this.stationClicked,this.customLegend=a.customLegend||null,this.showLegend=a.showLegend||!0,this.legendFontSize=a.legendFontSize||this.fontSize,this.legendFontWeight=a.legendFontWeight||this.fontWeight,this.legendFontColour=a.legendFontColour||a.labelColour||"black",this.legendBackgroundColour=a.legendBackgroundColour||"rgba(255,255,255,0.7)",this.zoomControlBackgroundColour=a.zoomControlBackgroundColour||"#888",this.allowZoom=a.allowZoom||!0,this.zoomToFit=a.zoomToFit||!0,this.colours=a.colours||["#61A729","#EE5A35","#4591BA","yellow","pink"];var b=document.createElement("canvas").getContext("2d"),c=window.devicePixelRatio||1,d=b.webkitBackingStorePixelRatio||b.mozBackingStorePixelRatio||b.msBackingStorePixelRatio||b.oBackingStorePixelRatio||b.backingStorePixelRatio||1;this.PIXEL_RATIO=c/d}return a.prototype=Object.create(Object.prototype,{debug:{writable:!0},events:{writable:!0},width:{writable:!0},height:{writable:!0},mapWidth:{writable:!0},mapHeight:{writable:!0},mapRatioY:{writable:!0},elemRatioY:{writable:!0},posX:{writable:!0,value:0},posY:{writable:!0,value:0},anchorX:{writable:!0,value:0},anchorY:{writable:!0,value:0},pixelMultiplier:{writable:!0,value:1},zoomLevel:{writable:!0,value:0},minZoom:{writable:!0},maxZoom:{writable:!0},canZoom:{writable:!0,value:!1},zoomSteps:{writable:!0,value:[]},boundLeft:{writable:!0,value:0},boundRight:{writable:!0,value:0},boundTop:{writable:!0,value:0},boundBottom:{writable:!0,value:0},startPanX:{writable:!0,value:0},startPanY:{writable:!0,value:0},panning:{writable:!0,value:!1},listening:{writable:!0,value:!1},padding:{writable:!0},gridSize:{writable:!0},grid:{writable:!0,value:[]},gridSize:{writable:!0,value:{x:0,y:0}},stationRadius:{writable:!0},lineWidth:{writable:!0},lineSpacing:{writable:!0},labelLineHeight:{writable:!0},fontSize:{writable:!0},fontFamily:{writable:!0},fontWeight:{writable:!0},colours:{writable:!0},lastVerticalDirection:{writable:!0,value:2},lines:{writable:!0,value:[]},stations:{writable:!0,value:{}},createCanvases:{value:function(a,b){if(a){a.innerHTML="",this.listening||(console.log("adding event listeners to element"),a.addEventListener("resize",this.render.bind(this),!1),a.addEventListener("mousedown",this.startPan.bind(this),!0),a.addEventListener("touchstart",this.startPan.bind(this),!1),a.addEventListener("mousemove",this.pan.bind(this),!1),a.addEventListener("touchmove",this.pan.bind(this),!1),a.addEventListener("mouseup",this.endPan.bind(this),!1),a.addEventListener("touchend",this.endPan.bind(this),!1),a.addEventListener("mouseout",this.endPan.bind(this),!1),a.addEventListener("touchleave",this.endPan.bind(this),!1),"remove"in Element.prototype||(Element.prototype.remove=function(){this.parentNode&&this.parentNode.removeChild(this)}),this.listening=!0);var c=a.clientHeight,d=a.clientWidth;this.boundTop=Math.floor(c/2-1),this.boundBottom=Math.ceil(c/2+1),this.cellWidth=2*this.stationRadius,this.cellHeight=2*this.stationRadius,this.gridSize.x=Math.floor(d/this.cellWidth),this.gridSize.y=Math.floor(c/this.cellHeight),this.baseY=Math.ceil(this.gridSize.y/2);var e=document.createElement("canvas");this.debugPaper={canvas:e,pen:e.getContext("2d")},this.debugPaper.canvas.style.position="absolute",this.debugPaper.canvas.style.top="0px",this.debugPaper.canvas.style.left="0px",this.debugPaper.canvas.style.zIndex="10",this.debugPaper.canvas.width=d,this.debugPaper.canvas.height=c,this.debug&&a.appendChild(this.debugPaper.canvas);var f=document.createElement("canvas");this.linePaper={canvas:f,pen:f.getContext("2d")},this.linePaper.canvas.style.position="absolute",this.linePaper.canvas.style.top="0px",this.linePaper.canvas.style.left="0px",this.linePaper.canvas.style.zIndex="20",this.linePaper.canvas.width=d,this.linePaper.canvas.height=c,a.appendChild(this.linePaper.canvas);var g=document.createElement("canvas");this.stationPaper={canvas:g,pen:g.getContext("2d")},this.stationPaper.canvas.style.position="absolute",this.stationPaper.canvas.style.top="0px",this.stationPaper.canvas.style.left="0px",this.stationPaper.canvas.style.zIndex="30",this.stationPaper.canvas.width=d,this.stationPaper.canvas.height=c,a.appendChild(this.stationPaper.canvas);var h=document.createElement("canvas");this.imagePaper={canvas:h,pen:h.getContext("2d")},this.imagePaper.canvas.style.position="absolute",this.imagePaper.canvas.style.top="0px",this.imagePaper.canvas.style.left="0px",this.imagePaper.canvas.style.zIndex="30",this.imagePaper.canvas.width=d,this.imagePaper.canvas.height=c,a.appendChild(this.imagePaper.canvas);var i=document.createElement("canvas");this.labelPaper={canvas:i,pen:i.getContext("2d")},this.labelPaper.canvas.style.position="absolute",this.labelPaper.canvas.style.top="0px",this.labelPaper.canvas.style.left="0px",this.labelPaper.canvas.style.zIndex="40",this.labelPaper.canvas.width=d,this.labelPaper.canvas.height=c,a.appendChild(this.labelPaper.canvas);var j=document.createElement("canvas");this.panningPaper={canvas:j,pen:j.getContext("2d")},this.panningPaper.canvas.style.position="absolute",this.panningPaper.canvas.style.top="0px",this.panningPaper.canvas.style.left="0px",this.panningPaper.canvas.style.zIndex="50",this.panningPaper.canvas.width=d,this.panningPaper.canvas.height=c,a.appendChild(this.panningPaper.canvas);var k=document.createElement("canvas");this.legendPaper={canvas:k,pen:k.getContext("2d")},this.legendPaper.canvas.style.position="absolute",this.legendPaper.canvas.style.top="0px",this.legendPaper.canvas.style.left="0px",this.legendPaper.canvas.style.zIndex="45",this.legendPaper.canvas.width=d,this.legendPaper.canvas.height=c,a.appendChild(this.legendPaper.canvas),this.height=c,this.width=d}else this.debugPaper.canvas.width=this.width,this.linePaper.canvas.width=this.width,this.stationPaper.canvas.width=this.width,this.labelPaper.canvas.width=this.width}},allocateGridPosition:{value:function(a,b,c,d,e,f,g){function h(){switch(q.push(g),g){case 2:case 8:g=-1==f?4:6;break;case 4:case 6:g=2==this.lastVerticalDirection?8:2,this.lastVerticalDirection=g}3==q.length&&(o++,p=0,q=[])}g=1==f?6:4;for(var i,j=!1,k=0,l=(c.label.hCount+1,e.longestStation||10),m=!1,n=(this.grid[a][b],0),o=1,p=0,q=[];!j&&1e3>k;){k++,p++,m=!1;var r=0,s=0;switch(g){case 2:s=-1;break;case 4:r=-1;break;case 6:r=1;break;case 8:s=1}for(var t=a+p*o*r,u=b+p*o*s,v=[],w=0;l>w;w++){var x=t+r*w+(l-1)*r,y=u+s*w+(l-1)*s;if(this.grid[x]||(this.grid[x]={}),this.grid[x][y]||this.createNewGridCell(x,y),this.grid[x][y]&&!this.grid[x][y].occupied){i=this.grid[x][y];break}if(this.grid[x][y]&&this.grid[x][y].occupied&&"blocked"!=this.grid[x][y].item){i=null;break}}if(i&&l>p){n++;for(var z=!1,A=!0,w=1;w<c.label.hCount+1;w++)if(this.grid[i.h+w]||(this.grid[i.h+w]={}),this.grid[i.h+w][i.v]||this.createNewGridCell(i.h+w,i.v),this.grid[i.h+w][i.v]&&this.grid[i.h+w][i.v].occupied){i=null,A=!1,m=!0;break}if(A)for(var B=i.v-1,C=i.h+1,D=e.longestStation,E=0;D>E;E++){for(var F=0;D>F;F++){if(this.grid[C+F]||this.createNewGridCell(C+F,B-E),this.grid[C+F][B-E]&&this.grid[C+F][B-E].occupied){i=null,m=!0;break}if(this.grid[C+F][B-E]||this.createNewGridCell(C+F,B-E),v.push(this.grid[C+F][B-E]),E==D-1&&F==D-1){if(this.debug&&console.log("Using cells for "+c.name),d){2==g?d.label.hCount:c.label.hCount;if(2==g)for(var w=0;w<d.label.hCount+1;w++)this.useCell(i.h,i.v+w,"blocked");for(var w=1;D+1>w;w++)this.debug&&console.log("Blocking cells for "+c.name),this.useCell(i.h+w,i.v,"blocked"),this.useCell(i.h,i.v-w,"blocked")}else for(var w=1;D+1>w;w++)this.debug&&console.log("Blocking cells for "+c.name),this.useCell(i.h+w,i.v,"blocked"),this.useCell(i.h,i.v-w,"blocked");this.useCell(i.h,i.v,"station");for(var G=0;G<v.length;G++)this.useCell(v[G].h,v[G].v,"label");return c.gridLoc=i,c.labelLoc=v[0],j=!0,g}}if(m){m=!1,(n>8||z)&&h.call(this);break}}}else h.call(this)}}},buildStationData:{value:function(a){for(var b in a){for(var c in a)if(a[b].name!=a[c].name||1==a.length)for(var d in a[b].stations){if(!this.stations[a[b].stations[d].name]){this.stations[a[b].stations[d].name]={lines:[a[b].name],hLinesDrawn:0,vLinesDrawn:0,hAboveLinesDrawn:0,hBelowLinesDrawn:0,vLeftLinesDrawn:0,vRightLinesDrawn:0,mode:"normal"};for(var e in a[b].stations[d])this.stations[a[b].stations[d].name][e]=a[b].stations[d][e]}for(var f in a[c].stations)a[b].stations[d].name==a[c].stations[f].name&&(a[c].stations[f].status>0&&(this.stations[a[b].stations[d].name].status=a[c].stations[f].status),-1==this.stations[a[b].stations[d].name].lines.indexOf(a[b].name)&&this.stations[a[b].stations[d].name].lines.push(a[b].name))}}this.lines=a}},buildLegendData:{value:function(){if(this.customLegend)this.legend=this.customLegend;else for(var a=0;a<this.lines.length;a++){var b={name:this.lines[a].name};this.lines[a].colour?b.colour=this.lines[a].colour:Array.isArray(this.colours)?b.colour=this.colours[a]:this.colours[this.lines[a].name]?b.colour=this.colours[this.lines[a].name]:b.colour="black",this.legend.push(b)}}},processFirstLine:{value:function(){var a,b,c,d=this.lines[0].stations.length,e=(this.stations[this.lines[0].stations[0].name].label,this.lines[0].longestStation||10);a=1,b=Math.ceil(this.gridSize.y/2);for(var f=0;d>f;f++){this.stations[this.lines[0].stations[f].name].label;if(d>f)for(var g=0;g<this.lines[0].longestStation+1;g++)this.useCell(a+g,b,"blocked"),this.useCell(a,b-g,"blocked");this.useCell(a,b,"station"),c=this.grid[a][b],this.lines[0].stations[f].gridLoc=c,this.stations[this.lines[0].stations[f].name].gridLoc=c;for(var h=b-1,i=a+1,j=0;j<this.lines[0].longestStation;j++)for(var k=0;k<this.lines[0].longestStation;k++)this.useCell(i+k,h-j,"label"),0==j&&0==k&&(this.stations[this.lines[0].stations[f].name].labelLoc=this.grid[i][h]);this.lines[0].stations[f];a+=e+1}}},processStations:{value:function(){for(var a=1;a<this.lines.length;a++){var b,c=this.lines[a].stations.length,d=[],e=0,f=0;for(d=[];d.length<this.lines[a].stations.length;){for(var g=f;c>g;g++){if(this.stations[this.lines[a].stations[g].name].gridLoc){e=g;break}e=null}if(null!=e){for(var h=e;h>f-1;h--){var i=(this.stations[this.lines[a].stations[e].name].gridLoc,this.stations[this.lines[a].stations[h].name].gridLoc);if(i){if(this.lines[a].stations[h+1]){var j=this.stations[this.lines[a].stations[h+1].name].gridLoc;j&&(j.v==i.v?b=4:j.h==i.h&&(b=j.v>i.v?2:8))}d.push(this.lines[a].stations[h].name)}else{var k=this.stations[this.lines[a].stations[h+1].name],j=k.gridLoc,l=j.h,m=j.v;b=this.allocateGridPosition(l,m,this.stations[this.lines[a].stations[h].name],k,this.lines[a],-1,b),d.push(this.lines[a].stations[h].name)}}f=e+1}else{for(var n=f;n<this.lines[a].stations.length;n++)if(0==n){var o=this.getFreeY(1);b=this.allocateGridPosition(1,o,this.stations[this.lines[a].stations[n].name],null,this.lines[a],1,6),d.push(this.lines[a].stations[n].name)}else{var k=this.stations[this.lines[a].stations[n-1].name],l=k.gridLoc.h,m=k.gridLoc.v;b=this.allocateGridPosition(l,m,this.stations[this.lines[a].stations[n].name],k,this.lines[a],1,6),d.push(this.lines[a].stations[n].name)}f=this.lines[a].stations.length}}}}},useCell:{value:function(a,b,c){this.debug&&console.log("Using cell "+a+":"+b+" as ("+c+")");this.cellWidth,this.cellHeight;if(this.grid[a]||(this.grid[a]={}),this.grid[a][b]||this.createNewGridCell(a,b),this.grid[a][b].occupied=!0,this.grid[a][b].item=c,this.debug){switch(this.debugPaper.pen.beginPath(),c){case"station":this.debugPaper.pen.fillStyle="blue";break;case"label":this.debugPaper.pen.fillStyle="yellow";break;case"blocked":this.debugPaper.pen.fillStyle="#CCC";break;default:this.debugPaper.pen.fillStyle="red"}this.debugPaper.pen.arc(this.grid[a][b].center.x,this.grid[a][b].center.y,this.stationRadius,0,2*Math.PI),this.debugPaper.pen.fill()}this.boundLeft=Math.min(this.boundLeft,this.grid[a][b].locs.a.x),this.boundRight=Math.max(this.boundRight,this.grid[a][b].locs.c.x),this.boundTop=Math.min(this.boundTop,this.grid[a][b].locs.a.y),this.boundBottom=Math.max(this.boundBottom,this.grid[a][b].locs.g.y)}},getLabelInfo:{value:function(){var a={};this.labelPaper.pen.beginPath(),this.labelPaper.pen.font=this.font;for(var b in this.stations){var c=b.split(" "),a=this.labelPaper.pen.measureText(b),d={};if(c.length>1){var e=this.cellWidth*this.labelWrapThreshold;this.labelPaper.pen.font=this.fontWeight+" "+this.fontSize+"px "+this.fontFamily;for(var f=(this.labelPaper.pen.measureText(e),0),g=[],h="",i=0;i<c.length;i++){var j=this.labelPaper.pen.measureText(h+" "+c[i]);j.width<=e||h.split(" ").length<=1?(" "!=h.split("")[h.length-1]&&(h+=" "),h+=c[i],i<c.length&&(h+=" ")):(g.push(h.trim()),f=g[f].length>g[g.length-1].length?f:g.length-1,h=c[i])}g.push(h),f=g[f].length>g[g.length-1].length?f:g.length-1;for(var j=this.labelPaper.pen.measureText(g[f]).width,i=0;i<this.stations[b].lines.length;i++)for(var k=0;k<this.lines.length;k++)this.stations[b].lines[i]==this.lines[k].name&&(this.lines[k].longestStation||(this.lines[k].longestStation=0),this.lines[k].longestStation=Math.max(this.lines[k].longestStation,Math.ceil(j/this.cellWidth)));d.hCount=Math.ceil(j/this.cellWidth),d.vCount=d.hCount,d.lines=g}else d.hCount=Math.ceil(a.width/this.cellWidth),d.vCount=d.hCount,d.lines=[b];this.stations[b].label=d}}},getFreeY:{value:function(a){for(var b,c=0,d=!1,e=0;!d&&1e3>c;){for(var f=0;8>f;f++){if(this.grid[a][this.baseY+f*e]||this.createNewGridCell(a,this.baseY+f*e),this.grid[a][this.baseY+f*e]&&!this.grid[a][this.baseY+f*e].occupied)return b=this.baseY+f*e,d=!0,b;c++}for(var f=0;8>f;f++){if(this.grid[a][this.baseY+f*e]||this.createNewGridCell(a,this.baseY+f*e),this.grid[a][this.baseY-f*e]&&!this.grid[a][this.baseY-f*e].occupied)return b=this.baseY-f*e,d=!0,b;c++}e++}return!1}},createNewGridCell:{value:function(a,b){var c=a,d=b,e=this.cellWidth,f=this.cellHeight;a*=e,b*=f,this.grid[c]||(this.grid[c]={}),this.grid[c][d]={center:{x:a+e/2,y:b+f/2},h:c,v:d,locs:{a:{x:a,y:b},b:{x:a+e/2,y:b},c:{x:a+e,y:b},d:{x:a,y:b+f/2},e:{x:a+e/2,y:b+f/2},f:{x:a+e,y:b+f/2},g:{x:a,y:b+f},h:{x:a+e/2,y:b+f},i:{x:a+e,y:b+f}},occupied:!1,item:null}}},centerMap:{value:function(){function a(a,b,c){return"undefined"==typeof c||0===+c?Math[a](b):(b=+b,c=+c,isNaN(b)||"number"!=typeof c||c%1!==0?NaN:(b=b.toString().split("e"),b=Math[a](+(b[0]+"e"+(b[1]?+b[1]-c:-c))),b=b.toString().split("e"),+(b[0]+"e"+(b[1]?+b[1]+c:c))))}this.mapWidth=this.boundRight-this.boundLeft+60,this.mapHeight=this.boundBottom-this.boundTop,this.mapRatioY=this.mapWidth/this.mapHeight,this.elemRatioY=this.width/this.height;var b=0,c=0;if(this.posX=(this.width-this.mapWidth)/2,this.posY=(this.height-this.mapHeight)/2-this.boundTop,this.mapWidth>this.width&&(b=this.mapWidth-this.width,this.posX=30),this.mapHeight>this.height&&(c=this.mapHeight-this.height,this.posY=Math.abs(this.boundTop)+(this.height-this.mapHeight)/2),this.allowZoom===!0){var d=1,e=1;b>0&&(d=this.mapWidth/this.width),c>0&&(e=this.mapHeight/this.height),e>d?this.pixelMultiplier=1/e:this.pixelMultiplier=1/d}if(this.pixelMultiplier<1){this.canZoom=!0,this.zoomLevel=0,this.pixelMultiplier=a("floor",this.pixelMultiplier,-1),this.minZoom=this.pixelMultiplier;var f=a("floor",this.minZoom,-1);this.zoomSteps.push(this.minZoom);for(var g=10*f+1;11>g;g++)this.zoomSteps.push(g/10);this.maxZoom=this.zoomSteps.length-1,this.zoomToFit===!0?(this.posX=Math.abs(this.boundLeft*this.pixelMultiplier)+(this.width-this.mapWidth*this.pixelMultiplier)/2,this.posY=Math.abs(this.boundTop*this.pixelMultiplier)+(this.height-this.mapHeight*this.pixelMultiplier)/2):(this.pixelMultiplier=this.zoomSteps[this.zoomSteps.length-1],this.zoomLevel=this.zoomSteps.length-1)}}},buildGrid:{value:function(){for(var a=0,b=0,c=0,d=(this.cellWidth,this.cellHeight,0);d<this.gridSize.y;d++){for(var e=0;e<this.gridSize.x;e++)c++,this.grid[e]||(this.grid[e]={}),this.grid[e][d]||this.createNewGridCell(e,d),a+=this.cellWidth;a=0,b+=this.cellHeight}}},drawGrid:{value:function(){if(this.debug){this.cellWidth,this.cellHeight;this.debugPaper.canvas.width=this.width,this.debugPaper.pen.translate(this.posX,this.posY),this.debugPaper.pen.scale(this.pixelMultiplier,this.pixelMultiplier),this.debugPaper.pen.beginPath(),this.debugPaper.pen.strokeStyle="#E2E2E2";for(var a in this.grid)for(var b in this.grid[a])this.debugPaper.pen.rect(this.grid[a][b].locs.a.x,this.grid[a][b].locs.a.y,this.cellWidth,this.cellHeight);this.debugPaper.pen.stroke()}}},drawLines:{value:function(a){if(a&&1==a)for(var b in this.stations)this.stations[b].vLinesDrawn=0,this.stations[b].vLeftLinesDrawn=0,this.stations[b].vRightLinesDrawn=0,this.stations[b].hLinesDrawn=0,this.stations[b].hAboveLinesDrawn=0,this.stations[b].hBelowLinesDrawn=0;this.linePaper.canvas.width=this.width,this.linePaper.pen.translate(this.posX,this.posY),this.linePaper.pen.scale(this.pixelMultiplier,this.pixelMultiplier);var c,d,e,f,g,h;for(var i in this.lines){var j=this.lines[i].stations;c=this.stations[j[0].name].gridLoc.center.x,d=this.stations[j[0].name].gridLoc.center.y,e=0,f=0;for(var k=0;k<j.length;k++)this.linePaper.pen.beginPath(),this.linePaper.pen.moveTo(c+e,d+f),this.lines[i].colour?this.linePaper.pen.strokeStyle=this.lines[i].colour:Array.isArray(this.colours)?this.linePaper.pen.strokeStyle=this.colours[i]:this.colours[this.lines[i].name]?this.linePaper.pen.strokeStyle=this.colours[this.lines[i].name]:this.linePaper.pen.strokeStyle="black",0==j[k].status&&(this.linePaper.pen.strokeStyle=this.inactiveColour),this.linePaper.pen.lineWidth=this.lineWidth,this.linePaper.pen.lineJoin="round",this.linePaper.pen.lineCap="round",j[k+1]?(this.stations[j[k].name].gridLoc.center.x==this.stations[j[k+1].name].gridLoc.center.x?(g="v",vLeft=this.stations[j[k].name].vLeftLinesDrawn<=this.stations[j[k].name].vRightLinesDrawn==1?-1:1,this.stations[j[k].name].vLinesDrawn>0&&this.stations[j[k+1].name].vLinesDrawn>0?(e=-1==vLeft?this.lineSpacing*vLeft+this.lineSpacing*this.stations[j[k].name].vLeftLinesDrawn*vLeft:this.lineSpacing*vLeft+this.lineSpacing*this.stations[j[k].name].vRightLinesDrawn*vLeft,this.linePaper.pen.moveTo(c+e,d)):(e=0,this.linePaper.pen.moveTo(c+e,d))):this.stations[j[k].name].gridLoc.center.y==this.stations[j[k+1].name].gridLoc.center.y&&(g="h",hBelow=this.stations[j[k].name].hBelowLinesDrawn<=this.stations[j[k].name].hAboveLinesDrawn==1?1:-1,this.stations[j[k].name].hLinesDrawn>0&&this.stations[j[k+1].name].hLinesDrawn>0?(f=1==hBelow?this.lineSpacing*hBelow+this.lineSpacing*this.stations[j[k].name].hBelowLinesDrawn*hBelow:this.lineSpacing*hBelow+this.lineSpacing*this.stations[j[k].name].hAboveLinesDrawn*hBelow,this.linePaper.pen.moveTo(c,d+f)):(f=0,this.linePaper.pen.moveTo(c,d+f))),g!=h&&("h"==g?e=0:f=0),c=this.stations[j[k+1].name].gridLoc.center.x,d=this.stations[j[k+1].name].gridLoc.center.y,0!=j[k].status&&0!=j[k+1].status||(this.linePaper.pen.strokeStyle=this.inactiveColour),this.linePaper.pen.lineTo(c+e,d+f),this.linePaper.pen.stroke(),"h"==g?(1==hBelow&&this.stations[j[k].name].hLinesDrawn>0?this.stations[j[k].name].hBelowLinesDrawn++:this.stations[j[k].name].hLinesDrawn>0&&this.stations[j[k].name].hAboveLinesDrawn++,this.stations[j[k].name].hLinesDrawn++,"v"==h&&this.stations[j[k].name].vLinesDrawn++):(-1==vLeft&&this.stations[j[k].name].vLinesDrawn>0?this.stations[j[k].name].vLeftLinesDrawn++:this.stations[j[k].name].vLinesDrawn>0&&this.stations[j[k].name].vRightLinesDrawn++,this.stations[j[k].name].vLinesDrawn++,"h"==h&&this.stations[j[k].name].hLinesDrawn++),h=g):this.stations[j[k].name].lines.length<=2&&("h"==g?(1==hBelow&&this.stations[j[k].name].hLinesDrawn>0?this.stations[j[k].name].hBelowLinesDrawn++:this.stations[j[k].name].hLinesDrawn>0&&this.stations[j[k].name].hAboveLinesDrawn++,this.stations[j[k].name].hLinesDrawn++,"v"==h&&this.stations[j[k].name].vLinesDrawn++):(-1==vLeft&&this.stations[j[k].name].vLinesDrawn>0?this.stations[j[k].name].vLeftLinesDrawn++:this.stations[j[k].name].vLinesDrawn>0&&this.stations[j[k].name].vRightLinesDrawn++,this.stations[j[k].name].vLinesDrawn++,"h"==h&&this.stations[j[k].name].hLinesDrawn++))}}},drawStations:{value:function(){var a=this;this.stationPaper.canvas.width=this.width,this.stationPaper.pen.translate(this.posX,this.posY),this.stationPaper.pen.scale(this.pixelMultiplier,this.pixelMultiplier);for(var b=[],c=0;c<this.lines.length;c++)for(var d=0;d<this.lines[c].stations.length;d++)if(this.stations[this.lines[c].stations[d].name].gridLoc&&-1==b.indexOf(a.lines[c].stations[d].name)){var e=this.stations[this.lines[c].stations[d].name],f=e.gridLoc.center.x,g=e.gridLoc.center.y;this.stationPaper.pen.beginPath(),this.stationPaper.pen.strokeStyle=this.stationColour,this.stationPaper.pen.fillStyle="white",0==e.status&&(this.stationPaper.pen.strokeStyle=this.inactiveColour),this.stationPaper.pen.lineWidth=this.stationThickness;var h=(this.lines[c].stations[d].qState,Math.ceil(this.stationRadius-this.lineWidth/2));if("highlight"==this.lines[c].stations[d].mode&&(h*=this.highlightScale),this.lines[c].stations[d].custom){var i=this.lines[c].stations[d].custom;i.fill&&(this.stationPaper.pen.fillStyle=i.fill),i.stroke&&(this.stationPaper.pen.strokeStyle=i.stroke),i.scale&&(h*=i.scale)}this.stationPaper.pen.arc(f,g,h,0,2*Math.PI),this.stationPaper.pen.stroke(),this.stationPaper.pen.fill(),b.push(a.lines[c].stations[d].name)}}},drawImages:{value:function(){function a(a,c,d,e,f){if(f.customImage)b.imagePaper.pen.drawImage(f.customImage,a-e,c-e,2*e,2*e);else{var g=new Image;g.onload=function(){b.imagePaper.pen.drawImage(g,a-e,c-e,2*e,2*e),f.customImage=g},g.src=d}}var b=this;this.imagePaper.canvas.width=this.width,this.imagePaper.pen.translate(this.posX,this.posY),this.imagePaper.pen.scale(this.pixelMultiplier,this.pixelMultiplier);for(var c=0;c<this.lines.length;c++)for(var d=0;d<this.lines[c].stations.length;d++)if(this.stations[this.lines[c].stations[d].name].gridLoc){var e=this.stations[this.lines[c].stations[d].name],f=e.gridLoc.center.x,g=e.gridLoc.center.y,h=this.stationRadius;if(this.imagePaper.pen.beginPath(),this.lines[c].stations[d].custom){var i=this.lines[c].stations[d].custom;i.image&&(i.scale&&(h*=i.scale),i.imageSize&&(h=i.imageSize/2),a(f,g,i.image,h,e))}}}},drawLabels:{value:function(){this.labelPaper.canvas.width=this.width,this.labelPaper.pen.translate(this.posX,this.posY),this.labelPaper.pen.scale(this.pixelMultiplier,this.pixelMultiplier);for(var a in this.stations)if(this.stations[a].labelLoc){var b=this.stations[a],c=b.labelLoc.center.x,d=b.labelLoc.center.y,e=0,f=0;this.labelPaper.pen.save(),this.labelPaper.pen.beginPath();var g=this.fontSize;if("highlight"==b.mode&&(g*=this.highlightScale),this.labelPaper.pen.font=this.fontWeight+" "+g+"px "+this.fontFamily,this.labelPaper.pen.textAlign="left",this.labelPaper.pen.textBaseline="middle",this.labelPaper.pen.fillStyle=this.labelColour,0==b.status&&(this.labelPaper.pen.fillStyle=this.inactiveColour),this.labelPaper.pen.translate(c,d),this.labelPaper.pen.rotate(-45*Math.PI/180),!b.custom||void 0==!b.custom.drawLabel||b.custom.drawLabel!==!1)for(var h=0;h<this.stations[a].label.lines.length;h++)this.labelPaper.pen.fillText(this.stations[a].label.lines[h],e,f),f+=this.labelLineHeight;this.labelPaper.pen.fill(),this.labelPaper.pen.restore()}}},drawLegend:{value:function(){this.legendPaper.canvas.width=this.width;for(var a=100,b=40,c=0,d=0;d<this.legend.length;d++){var e=this.legendPaper.pen.measureText(this.legend[d].name);c=Math.max(c,e.width),b+=10}if(b-=10,a+=c,this.width/a<5||this.height/b<5){var f=this.width/a/5;this.legendPaper.pen.scale(f,f)}this.legendPaper.pen.save(),this.legendPaper.pen.beginPath(),this.legendPaper.pen.rect(0,0,a,b),this.legendPaper.pen.fillStyle=this.legendBackgroundColour,this.legendPaper.pen.fill(),this.legendPaper.pen.closePath(),this.legendPaper.pen.restore();for(var g=20,h=20,d=0;d<this.legend.length;d++)this.legendPaper.pen.beginPath(),this.legendPaper.pen.moveTo(g,h),this.legend[d].colour?this.legendPaper.pen.strokeStyle=this.legend[d].colour:this.legendPaper.pen.strokeStyle="black",this.legendPaper.pen.lineWidth=this.lineWidth,this.legendPaper.pen.lineTo(g+50,h),this.legendPaper.pen.stroke(),this.legendPaper.pen.beginPath(),this.legendPaper.pen.moveTo(g+60,h),this.legendPaper.pen.font=this.legendFontWeight+" "+this.legendFontSize+"px "+this.fontFamily,this.legendPaper.pen.textAlign="left",this.legendPaper.pen.textBaseline="middle",this.legendPaper.pen.fillStyle=this.legendFontColour,this.legendPaper.pen.fillText(this.legend[d].name,g+60,h),this.legendPaper.pen.fill(),h+=this.lineWidth+10}},drawZoomControls:{value:function(a){if(!a){if(!this.zoomPaper)return;a=this.zoomPaper.canvas.parentElement}this.zoomPaper&&this.zoomPaper.canvas&&this.zoomPaper.canvas.remove();var b=document.createElement("canvas");if(this.zoomPaper={canvas:b,pen:b.getContext("2d")},this.zoomPaper.canvas.style.position="absolute",this.zoomPaper.canvas.style.top="0px",this.zoomPaper.canvas.style.left="0px",this.zoomPaper.canvas.style.zIndex="55",this.zoomPaper.canvas.width=this.width,this.zoomPaper.canvas.height=this.height,a.appendChild(this.zoomPaper.canvas),this.canZoom){var c,d;c=this.width/this.pixelMultiplier-30/this.pixelMultiplier,d=45/this.pixelMultiplier,this.zoomPaper.pen.beginPath(),this.zoomLevel<this.maxZoom?this.zoomPaper.pen.fillStyle=this.zoomControlBackgroundColour:this.zoomPaper.pen.fillStyle=this.inactiveColour,this.zoomPaper.pen.lineWidth=3/this.pixelMultiplier,this.zoomPaper.pen.arc(this.width-15,30,12,0,2*Math.PI),this.zoomPaper.pen.closePath(),this.zoomPaper.pen.fill(),this.zoomPaper.pen.beginPath(),this.zoomLevel>this.minZoom?this.zoomPaper.pen.fillStyle=this.zoomControlBackgroundColour:this.zoomPaper.pen.fillStyle=this.inactiveColour,this.zoomPaper.pen.lineWidth=3/this.pixelMultiplier,this.zoomPaper.pen.arc(this.width-15,60,12,0,2*Math.PI),this.zoomPaper.pen.closePath(),this.zoomPaper.pen.fill(),this.zoomPaper.pen.beginPath(),this.zoomPaper.pen.fillStyle="white",this.zoomPaper.pen.font="16px "+this.fontFamily,this.zoomPaper.pen.textAlign="center",this.zoomPaper.pen.textBaseline="middle",this.zoomPaper.pen.fillText("+",this.width-15,31),this.zoomPaper.pen.fillText("-",this.width-15,60),this.zoomPaper.pen.closePath(),this.zoomPaper.pen.fill()}}},createEventListeners:{value:function(a){var b=this;if(!a){if(!this.eventPaper)return;a=this.eventPaper.canvas.parentElement}this.eventPaper&&this.eventPaper.canvas&&this.eventPaper.canvas.remove();var c=document.createElement("canvas");this.eventPaper={canvas:c,pen:c.getContext("2d")},this.eventPaper.canvas.style.position="absolute",this.eventPaper.canvas.style.top="0px",this.eventPaper.canvas.style.left="0px",this.eventPaper.canvas.style.zIndex="60",this.eventPaper.canvas.width=this.width,this.eventPaper.canvas.height=this.height,a.appendChild(this.eventPaper.canvas);var d=new Events(this.eventPaper.canvas,this.eventPaper.pen);this.eventPaper.canvas.width=this.width,this.eventPaper.pen.translate(this.posX,this.posY),this.eventPaper.pen.scale(this.pixelMultiplier,this.pixelMultiplier);var e=d.getContext();e.save(),d.setStage(function(){this.clear();for(var a=[],c=0;c<b.lines.length;c++)for(var d=0;d<b.lines[c].stations.length;d++)if(b.stations[b.lines[c].stations[d].name].gridLoc&&-1==a.indexOf(b.lines[c].stations[d].name)){var f=b.stations[b.lines[c].stations[d].name],g=f.gridLoc.locs.a.x,h=f.gridLoc.locs.a.y;this.beginRegion(),e.beginPath(),e.strokeStyle="transparent",b.debug&&(e.strokeStyle="red"),e.rect(g,h,b.cellWidth,b.cellHeight),e.closePath(),e.stroke(),this.addRegionEventListener("mousedown",b.preClick.bind(b,b.lines[c].stations[d],!0)),this.addRegionEventListener("touchdown",b.preClick.bind(b,b.lines[c].stations[d],!0)),
this.addRegionEventListener("mouseover",b.highlightStation.bind(b,b.lines[c].stations[d],!1)),this.addRegionEventListener("mouseout",b.removeStationHighlight.bind(b,b.lines[c].stations[d],!1)),this.closeRegion(),a.push(b.lines[c].stations[d].name)}if(b.canZoom){var i,j;i=b.width/b.pixelMultiplier-30/b.pixelMultiplier,j=45/b.pixelMultiplier,e.save(),this.beginRegion(),e.beginPath(),e.lineWidth=3/b.pixelMultiplier,e.arc(b.width/b.pixelMultiplier-15/b.pixelMultiplier-b.posX/b.pixelMultiplier,30/b.pixelMultiplier-b.posY/b.pixelMultiplier,12/b.pixelMultiplier,0,2*Math.PI),e.closePath(),b.panning||e.stroke(),b.zoomLevel<b.maxZoom&&(this.addRegionEventListener("mousedown",b.zoomIn.bind(b,null,!0)),this.addRegionEventListener("touchdown",b.zoomIn.bind(b,null,!0))),this.closeRegion(),this.beginRegion(),e.beginPath(),e.lineWidth=3/b.pixelMultiplier,e.arc(b.width/b.pixelMultiplier-15/b.pixelMultiplier-b.posX/b.pixelMultiplier,60/b.pixelMultiplier-b.posY/b.pixelMultiplier,12/b.pixelMultiplier,0,2*Math.PI),e.closePath(),b.panning||e.stroke(),b.zoomLevel>b.minZoom&&(this.addRegionEventListener("mousedown",b.zoomOut.bind(b,null,!0)),this.addRegionEventListener("touchdown",b.zoomOut.bind(b,null,!0))),this.closeRegion()}})}},setupPanning:{value:function(){var a=this,b=new Events(this.eventPaper.canvas,this.eventPaper.pen),c=b.getContext();b.setStage(function(){this.clear(),this.beginRegion(),c.beginPath(),c.rect(0,0,a.width,a.height),this.addRegionEventListener("mousedown",a.startPan.bind(a,this,!1)),this.addRegionEventListener("mouseup",a.endPan.bind(a,this,!1)),this.addRegionEventListener("mousemove",a.pan.bind(a,this,!1)),c.closePath(),c.stroke(),this.closeRegion()})}},render:{value:function(a,b,c){this.createCanvases(b),a&&!a.target&&(this.stations={},this.legend=[],this.grid={},this.buildStationData(a),1==this.debug&&console.log("stations ready"),this.buildLegendData(),this.getLabelInfo(),1==this.debug&&console.log("labels ready"),1==this.debug&&console.log("grid ready"),this.processFirstLine(),1==this.debug&&console.log("first line ready"),this.processStations(),1==this.debug&&console.log("station positions ready"),this.centerMap(),1==this.debug&&console.log("map transposed")),this.drawGrid(),1==this.debug&&console.log("grid drawn"),this.drawLines(),1==this.debug&&console.log("lines drawn"),this.drawStations(),1==this.debug&&console.log("stations drawn"),this.drawImages(),1==this.debug&&console.log("images drawn"),this.drawLabels(),1==this.debug&&console.log("labels drawn"),this.drawLegend(),1==this.debug&&console.log("legend drawn"),this.createEventListeners(b),1==this.debug&&console.log("events listening"),this.drawZoomControls(b)}},sampleData:{value:[{name:"Line1",colour:"#ff7373",stations:[{name:"Station A",status:1,custom:{fill:"#ff7373",scale:2}},{name:"Station B",status:1},{name:"Station C",status:1},{name:"Station D",status:1}]},{name:"Line2",colour:"#ffd546",stations:[{name:"Station D",status:1},{name:"Station E",status:1},{name:"Station F",status:1},{name:"Station G",status:1}]},{name:"Line3",colour:"#d47dbe",stations:[{name:"Station C",status:1},{name:"Station D",status:1},{name:"Station E",status:1},{name:"Station F",status:1},{name:"Station J",status:1},{name:"Station K",status:1},{name:"Station L",status:1}]},{name:"Line4",colour:"#68b5de",stations:[{name:"Station D",status:1},{name:"Station E",status:1},{name:"Station H",status:0},{name:"Station I",status:0}]},{name:"Line5",colour:"#86ae22",stations:[{name:"Station M",status:1,custom:{fill:"#86ae22",scale:2}},{name:"Station N",status:1},{name:"Station O",status:1},{name:"Station P",status:1},{name:"Station Q",status:1},{name:"Station R",status:1}]}]},clickInProgress:{value:!1},preClick:{value:function(a){this.removeStationHighlight(a),this.stationClicked(a)}},postClick:{value:function(){this.clickInProgress=!1}},stationClicked:{writable:!0,value:function(a){alert('you clicked station "'+a.name+'"')}},highlightStation:{value:function(a){this.disableHighlighting||(a.mode="highlight",this.drawStations(),this.drawLabels())}},removeStationHighlight:{value:function(a){this.disableHighlighting||(a.mode="normal",this.drawStations(),this.drawLabels())}},startPan:{value:function(a){var b=this.eventPaper.canvas.getBoundingClientRect();this.anchorX=this.posX,this.anchorY=this.posY,"touchstart"==a.type?(this.startPanX=a.touches[0].clientX-b.left-this.posX,this.startPanY=a.touches[0].clientY-b.top-this.posY):(this.startPanX=a.clientX-b.left-this.posX,this.startPanY=a.clientY-b.top-this.posY),this.panning=!0}},endPan:{value:function(a){this.panning=!1,this.startPanX=0,this.startPanY=0,this.anchorX=0,this.anchorY=0,this.createEventListeners()}},pan:{value:function(a){if(a.preventDefault(),this.panning){var b=this.eventPaper.canvas.getBoundingClientRect();if(-1!=a.type.indexOf("touch"))var c=a.touches[0].clientX-b.left,d=a.touches[0].clientY-b.top;else var c=a.clientX-b.left,d=a.clientY-b.top;this.posX=c-this.startPanX,this.posY=d-this.startPanY,this.drawGrid(),this.drawLines(!0),this.drawStations(),this.drawLabels(),this.drawImages(),this.drawZoomControls()}}},scaleAll:{value:function(){}},zoomIn:{value:function(){this.animateZoom(1,10,1,function(){this.zoomLevel++,this.pixelMultiplier=this.zoomSteps[this.zoomLevel],console.log(this.pixelMultiplier),this.drawGrid(),this.drawLines(!0),this.drawStations(),this.drawLabels(),this.drawImages(),this.drawZoomControls(),this.createEventListeners()})}},zoomOut:{value:function(a){this.animateZoom(1,10,-1,function(){this.zoomLevel--,this.pixelMultiplier=this.zoomSteps[this.zoomLevel],this.drawGrid(),this.drawLines(!0),this.drawStations(),this.drawLabels(),this.drawImages(),this.drawZoomControls(),this.createEventListeners()})}},animateZoom:{value:function(a,b,c,d){var e=this;this.pixelMultiplier+=c/b/10,requestAnimFrame(function(){e.drawGrid(),e.drawLines(!0),e.drawStations(),e.drawLabels(),e.drawImages(),e.drawZoomControls(),e.createEventListeners(),a++,b>a?e.animateZoom(a,b,c,d):d.call(e)})}}}),a}();window.requestAnimFrame||(window.requestAnimFrame=function(a){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}());